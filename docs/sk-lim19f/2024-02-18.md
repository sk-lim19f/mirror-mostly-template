## 7.4 DHCP

-   정적 할당: 수동으로 IP와 네트워크 정보를 직접 설정하는 것
-   동적 할당: 자동으로 설정하는 것
-   IP를 동적으로 할당하는 데 사용되는 프로토콜이 DHCP
-   DHCP를 사용하면 사용자가 직접 입력해야 하는 IP 주소, 서브넷 마스크, 게이트웨이, DNS 정보를 자동으로 할당받아 사용할 수 있음
-   별도의 IP 설정 작업이 필요없어 사용자와 관리자 모두 편리하게 네트워크에 접속할 수 있고 사용하지 않는 IP 정보는 회수되어 사용하는 경우에만 재할당되어 사용자 이동이 많고 한정된 IP 주소를 가진 경우 유용하게 사용될 수 있음
-   또한, IP가 자동으로 관리되므로 사용자가 직접 입력하면서 발생할 수 있는 설정 정보오류나 중복 IP 할당과 같은 문제를 예방할 수 있음

### 7.4.1 DHCP 프로토콜

-   DHCP는 BOOTP라는 프로토콜을 기반으로 작동
-   DHCP는 BOOTP와 유사하게 동작하지만 BOOTP에서 지원되지 않는 몇 가지 기능이 추가된 확장 프로토콜
-   DHCP와 BOOTP 프로토콜 사이에는 호환성이 있어 BOOTP와 DHCP에서 사용되는 서비스 포트가 같고 BOOTP 클라이언트가 DHCP 서버를 사용하거나 DHCP 클라이언트가 BOOTP 서버를 사용해 정보를 수신할 수 있음
-   DHCP는 서버와 클라이언트로 동작하며 클라이언트의 서비스 포트는 68(bootpc), 서버의 서비스 포트는 67(bootps)

### 7.4.2 DHCP 동작 방식

-   DHCP를 이용해 IP를 자동으로 할당받기 위해 DHCP 클라이언트는 DHCP 서버를 찾기 위한 메시지를 전송하는데 이 메시지를 DHCP Discover 메시지라고 함
-   IP를 할당받는 과정이므로 패킷을 정상적으로 주고받을 수 없어 TCP가 아닌 UDP를 사용
-   클라이언트에 IP를 할당할 때는 단순히 IP 주소뿐만 아니라 서브넷, 게이트웨이, DNS 정보와 IP 주소 임대 시간, DHCP 서버 자신의 IP 정보를 포함한 메시지를 DHCP 클라이언트에 전송
-   이 메시지를 DHCP Offer 메시지라고 하며 서버가 클라이언트에 IP 주소 사용을 제한하는 단계
-   DHCP 클라이언트는 DHCP 서버로부터 제안받은 IP 정보를 사용하기 위해 DHCP Request 메시지를 DHCP 서버에 전송
-   DHCP 서버를 찾기 위한 Discover 메시지를 보낼 때는 현재 DHCP 서버가 어느 서버인지 알 수 없으므로 브로드캐스트로 전송하고 DHCP Request 메시지를 보낼 때도 유니캐스트가 아닌 브로드캐스트로 전송
-   마지막으로 DHCP 서버는 DHCP Request를 보낸 클라이언트에 최종 확인을 위한 응답 메시지 패킷을 보내는데 이것을 DHCP Acknowledgement 메시지라고 하며 내용은 DHCP Offer의 내용과 동일
-   DHCP를 통해 IP를 할당할 때는 IP 임대시간이 있음
    -   DHCP 서버는 클라이언트에 할당할 IP 정보와 함께 임대 시간을 지정해 전달
    -   임대 시간이 만료되면 클라이언트에 할당된 IP를 다시 IP Pool로 회수
    -   만약 클라이언트가 IP를 사용하는 도중 이렇게 임대시간이 모두 지나면 클라이언트가 사용하던 IP는 다시 수거되고 클라이언트는 다시 처음부터 DHCP Discover부터 시작해 IP를 재할당 받아야 함
    -   사용하던 IP 주소가 다른 클라이언트에 할당되면서 다른 IP가 할당될 수도 있음
    -   실제 동작 방식은 이처럼 매번 할당받은 IP 주소를 반환하고 다시 새로운 할당을 요청하는 과정을 반복하지는 않음
    -   현재 클라이언트가 IP를 사용 중인 경우, 갱신 과정을 거쳐 사용 중인 동안 IP 주소가 IP 풀에서 다시 반환되지 않고 계속 사용 가능

### 7.4.3 DHCP 서버 구성

-   DHCP 서버를 구성할 때는 클라이언트에 할당하게 될 IP 주소 풀을 포함해 다양한 속성과 정보를 설정할 수 있음
    -   IP 주소 풀(IP 범위)
        -   클라이언트에 할당할 IP 주소 범위
    -   예외 IP 주소 풀(예외 IP 범위)
        -   클라이언트에 할당할 IP 주소로 선언된 범위 중 예외적으로 할당하지 않을 대역
    -   임대 시간
        -   클라이어트에 할당할 IP 주소의 기본 임대 시간
    -   서브넷 마스크
        -   클라이언트에 할당할 IP 주소에 대한 서브넷 마스크 정보
    -   게이트웨이(Router)
        -   클라이언트에 할당할 게이트웨이 정보
    -   DNS
        -   클라이언트에 할당할 DNS 주소

#### 7.4.3.2 리눅스에서 DHCP 서버 구성

-   dhcp 패키지 설치

```
$ yum install dhcp
```

-   dhcp 서버를 구성하기 위해 dhcp 설정 파일 확인

```
/etec/dhcp/dhcpd.conf

DHCP Server Configuration file.
  see /usr/share/doc/dhcp*/dhcpd.conf.example
  see dhcpd.conf(5) man page
```

-   복사한 샘플 파일이나 man 페이지를 참조해 다음과 같이 설정 파일을 작성

```
default-lease-time 600; // 기본 임대 시간을 600초로 설정
max-lease-time 7200; // 최대 임대 시간을 7200초로 설정

subnet 10.10.10.0 netmask 255.255.255.0 {
range 10.10.10.10. 10.10.10.250; // 10.10.10.0 네트워크에 10.10.10.10 부터 10.10.10.250까지 클라이언트에 IP가 할당

option routers 10.10.10.254; // 디폴트 게이트웨이를 10.10.10.254로 설정
option domain-name-servers 8.8.8.8; // DNS 서버를 8.8.8.8로 설정
}
```

-   설정 파일을 작성한 후 dhcp 서비스 데몬을 실행

```
$ systemctl start dhcpd.service
```

### 7.4.4 DHCP 릴레이

-   여러 네트워크를 가진 환경에서도 DHCP 릴레이 에이전트 기능을 사용하면 DHCP 서버 한 대로 여러 네트워크 대역에서 IP 풀을 관리할 수 있음
-   DHCP 릴레이 에이전트가 DHCP 클라이언트와 DHCP 서버가 서로 다른 대역에 있는 경우, DHCP 패킷을 중간에서 중계하는 역할을 해주기 때문
-   즉, 릴레이 에이전트를 이용하면 DHCP 서버를 네트워크마다 구성하지 않고 중앙 DHCP 서버만으로도 여러 네트워크에서 DHCP 환경을 운영할 수 있음
