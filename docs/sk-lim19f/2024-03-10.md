# CKA Exam

-   오늘 오전에 CKA 시험을 보고 왔다.
-   좋은 결과가 있길 👍

## 12.6 로드 밸런서 동작 모드

-   로드 밸런서의 동작 방식은 다음 3가지
    -   트랜스패런트(Transparent: TP), 또는 브릿지
    -   라우티드
    -   DSR(Direct Server Return)

### 12.6.1 트랜스패런트 모드

-   트랜프패런트 구성은 로드 밸런서가 OSI 2계층 스위치처럼 동작하는 구성
-   즉, 로드 밸런서에서 서비스하기 위해 사용하는 VIP 주소와 실제 서버가 동일한 네트워크를 사용하는 구성
-   트랜스패런트 구성은 기존에 사용하던 네트워크 대역을 그대로 사용하므로 로드 밸런서 도입으로 인한 IP 네트워크 재설계를 고려하지 않아도 되고 네트워크에 L2 스위치를 추가하는 것과 동일하게 기존 망의 트래픽 흐름에 미치는 영향 없이 로드 밸런서를 손쉽게 구성할 수 있음
-   트랜스패런트 구성에서는 트래픽이 로드 밸런서를 지나더라도 부하 분산 서비스를 받는 트래픽인 경우에만 4계층 이상의 기능을 수행하며 부하 분산 서비스가 아닌 경우에는 기존 L2 스위치와 동일한 스위칭 기능만 수행

### 12.6.2 라우티드 모드

-   라우티드 구성은 이름에서도 알 수 있듯이 로드 밸런서가 라우팅 역할을 수행하는 모드
-   즉, 로드 밸런서를 기준으로 사용자 방향과 서버 방향이 서로 다른 네트워크로 분리된 구성
-   로드 밸런서는 사용자 방향과 서버 방향의 네트워크를 라우팅으로 연결
-   라우티드 모드는 보안 강화 목적으로 서버쪽 네트워크를 사설로 구성해 서버에 직접 접속하는 것을 막는 용도로 사용되기도 함

> 인라인 모드의 라우티드 구성에서 라우티드 모드의 로드 밸런서가 서버의 게이트웨이 역할을 하거나 로드 밸런서와 서버 사이에 또 다른 L3 장비를 통하는 경우, 해당 L3 장비에서 게이트웨이 역할을 할 수도 있음

### 12.6.3 DSR 모드

-   DSR(Direct Server Returm)은 명칭 그대로 사용자의 요청이 로드 밸런서를 통해 서버로 유입된 후에 다시 로드 밸런서를 통하지 않고 서버가 사용자에게 직접 응답하는 모드
-   로드 밸런서에는 응답 트래픽이 유입되지 않으므로 사용자가 요청하는 패킷에 대해서만 관여
-   DSR 모드는 응답할 때, 로드 밸런서를 경유하지 않으므로 원암으로 구성
-   DSR 모드는 L2 DSR과 L3 DSR 구분되는데 L2 DSR은 실제 서버의 네트워크를 로드 밸런서가 가진 경우이며 L3 DSR은 실제 서버의 네트워크 대역을 로드 밸런서가 가지지 않은 경우
-   즉, 로드 밸런서에서 실제 서버까지의 통신이 L2 통신인지, L3 통신인지에 따라 L2 DSR과 L3 DSR로 나눌 수 있음
-   DSR 모드에서는 요청 트래픽만 로드 밸런서를 통해 흐르므로 로드 밸런서 전체 트래픽이 감소해 로드 밸런서 부하가 감소
-   특히 일반적인 서비스 트래픽인 경우, 서비스 요청 패킷보다 서비스 응답 패킷의 크기가 더 크기 때문에 로드 밸런서의 트래픽 부하 감소에 효과적
-   반면, 이러한 효과가 있는 반면에 DSR 모드의 서비스 응답이 로드 밸런서를 경유하지 않으므로 문제가 발생했을 때, 문제 확인이 어려움
-   다른 동작 모드는 로드 밸런서 설정만 필요하지만 L2 DSR과 L3 DSR은 로드 밸런서 설정 외에 서버에서도 추가 설정이 필요
-   DSR 모드를 사용하려면 서버에서도 추가 설정이 필요
    -   루프백 인터페이스 설정
    -   리눅스 커널 파라미터 수정(리눅스) / 네트워크 설정 변경(윈도우)

## 12.7 로드 밸런서 유의사항

### 12.7.1 원암 구성의 동일 네트워크 사용 시

-   로드 밸런서를 거치면서 변경된 IP가 재응답할 때, 로드 밸런서를 경유하면서 원래의 IP로 바꾸어 응답해야 하지만 원암 구조에서는 응답 트래픽이 로드 밸런서를 경유하지 않아서 발생

#### 12.7.1.1 게이트웨이를 로드 밸런서로 설정

-   서버에서 동일 네트워크가 아닌 목적지로 가려면 게이트웨이를 통과해야 함
-   따라서 로드 밸런서를 통해 부하 분산이 이루어지는 실제 서버에 대해서는 게이트웨이를 로드 밸랜서로 설정하면 로컬 네트워크가 아닌 외부 사용자의 호출에 대한 응답이 항상 로드 밸런서를 통하므로 정상적으로 응답할 수 있게 됨
-   다만 이 경우, 물리적으로는 원암 구조이지만 실제 트래픽 플로가 로드 밸런서를 게이트웨이로 사용하므로 원암 구조에서 가질 수 있는 로드 밸런서의 부하 감소효과가 줄어듬
-   물론 부하 분산을 사용하지 않는 서버는 기존과 동일하게 게이트웨이를 L3 스위치로 설정하면 로드 밸런서를 경유하지 않으므로 여전히 로드 밸런서의 부하 감소효과를 가져올 수 있음

#### 12.7.1.2 Source NAT 사용

-   원암 구성의 동일 네트워크 문제를 해결하는 두 번째 방법은 Source NAT를 적용하는 것
-   사용자의 서비스 요청에 대해 로드 밸런서가 실제 서버로 가기 위해 수행하는 Destination NAT뿐만 아니라 출발지 IP 주소를 로드 밸런서가 가진 IP로 함께 변경
-   그럼 서버에서는 사용자의 요청이 아니라 로드 밸런서가 서비스 요청을 한 것으로 보이기 때문에 응답을 로드 밸런서를 보내게 됨
-   로드 밸런서는 응답 패킷의 출발지를 실제 서버에서 로드 밸런서에 있는 서비스 IP(VIP)로 바꾸고 목적지 IP 주소를 로드 밸런서의 IP에서 원래의 사용자 IP로 변경해 사용자에게 응답하게 함
-   다만 이 경우, 서버 애플리케이션 입장에서 보면 서비스를 호출한 IP가 하나의 동일한 IP로 보이기 때문에 사용자 구분이 어렵다는 문제가 있음
-   웹 서비스는 이런 문제를 해결하기 위해 HTTP 헤더의 X-Forwarded-For(XFF)를 사용해 실제 사용자 IP를 확인하는 방법을 사용

#### 12.7.1.3 DSR 모드

-   원암 구조의 동일 네트워크에서 DSR 모드를 사용할 수 있음
-   DSR 모드는 사용자의 서비스 요청 트래픽에 대해 별도의 Destination NAT를 수행하지 않고 실제 서버로 서비스 요청 패킷을 전송
-   각 서버에는 서비스 IP 정보가 루프백 인터페이스에 설정되어 있으며 서비스에 응답할 때, 루프백에 설정된 서비스 IP 주소를 출발지로 응답
