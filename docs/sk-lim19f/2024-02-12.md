# 6. 로드 밸런서 / 방화벽: 4계층 장비(세션 장비)

-   2, 3계층 장비에서 고려하지 않았던 통신의 방향성이나 순서와 같은 통신 전반에 대한 관리가 필요하며 이런 정보를 세션 테이블(Session Table)이라는 공간에 담아 관리

## 6.1 4계층 장비의 특징

-   4계층 장비는 TCP와 같은 4계층 헤더에 있는 정보를 이해하고 이 정보들을 기반으로 동작
-   기존 네트워크 장비와 다른 점을 이해해야 하는데 세션 테이블과 그 안에서 관리하는 세션 정보가 가장 중요
-   그래서 4계층 이상에서 동작하는 로드 밸런서, 방화벽과 같은 장비를 '세션 장비'라고 부름
-   세션 테이블
    -   세션 장비는 세션 테이블을 기반으로 운영
    -   세션 정보를 저장, 확인하는 작업 전반에 대한 이해가 필요
    -   세션 정보는 세션 테이블에 남아 있는 라이프타임이 존재
-   Symmetric(대칭)경로 요구
    -   Inbound와 Outbound 경로가 일치
-   정보 변경(로드 밸런서의 경우)
    -   IP 주소가 변경되며 확장된 L7 로드 밸런서(ADC)는 애플리케이션 프로토콜 정보도 변경

## 6.2 로드 밸런서

-   서버나 장비의 부하를 분산하기 위해 사용하는 장비를 흔히 로드 밸런서라고 부름
-   트래픽을 분배해주는 기능 때문인데 4계층 이상에서 동작하면서 IP 주소나 4계층 정보, 애플리케이션 정보를 확인, 수정하는 기능이 있음
-   가장 많이 쓰이는 분야는 웹 서버 부하 분산
-   내부 부품을 이중화하거나 용량이 더 큰 부품을 사용하면 가격이 크게 올라가므로 작은 장비 여러대를 묶어 사용하는 방법을 선호
-   이런 시스템 확장 방법을 스케일 아웃이라고 함

> 시스템 확장 방법: 스케일 업과 스케일 아웃

-   스케일 업은 기존 시스템에 CPU, 메모리, 디스크와 같은 내부 컴포넌트 용량을 키우거나 이것이 불가능 할 경우, 새로 더 큰 용량의 시스템을 구매해 서비스로 옮기는 방법
-   스케일 아웃은 같은 용량의 시스템을 여러 대 배치

-   작은 시스템 여러대를 운영하더라도 사용자는 서버 배치와 상관없이 하나의 서비스로 보여야 함
-   로드 밸런서가 서비스에 사용되는 대표 IP 주소를 서비스 IP로 갖고 그 밑에 시스템이 늘어나면 로드 밸런서가 서비스에 사용되는 IP 주소를 서비스 IP로 갖고 그 밑에 시스템이 늘어나면 로드 밸런서가 각 시스템의 실제 IP로 변경해 요청을 보냄
-   로드 밸런서는 동작하는 계층에 따라 4계층과 7계층으로 나누어짐
    -   L4 로드 밸런싱
        -   일반적인 로드 밸런서가 동작하는 방식
        -   TCP, UDP 정보(특히 포트 넘버)를 기반으로 로드 밸런싱을 수행
    -   L7 로드 밸런싱
        -   HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱을 수행
        -   HTTP 헤더 정보나 URI와 같은 정보를 기반으로 프로토콜을 이해한 후 부하를 분산할 수 있음
        -   일반적으로 이런 장비를 ADC(Application Delivery Controller)라고 부르며 프록시(Proxy) 역할을 수행
        -   스퀴드(Squid)나 Nginx에서 수행하는 리버스 프록시(Reverse Proxy)와 유사한 기능을 가지고 있음

> AWS에서는 NLB가 L4 로드 밸런싱, ALB가 L7 로드 밸런싱용 전용 컴포넌트

### 6.2.1 L4 스위치

-   L4 스위치는 용어 그대로 4계층에서 동작하면서 로드 밸런서 기능이 있는 스위치
-   L4 스위치는 부하 분산, 성능 최적화, 리다이렉션 기능을 제공
-   L4 스위치가 동작하려면 가상 서버(Virtual Server), 가상 IP(Virtual IP), 리얼 서버(Real Server)와 리얼 IP(Real IP)를 설정해야 함
-   가상 서버는 사용자가 바라보는 실제 서비스이고 가상 IP는 사용자가 접근해야 하는 서비스 IP 주소
-   리얼 서버는 실제 서비스를 수행하는 서버이고 리얼 IP는 실제 서버의 IP
-   L4 스위치는 가상 IP를 리얼 IP로 변경해주는 역할을 수행

### 6.2.2 ADC

-   ADC는 애플리케이션 계층에서 동작하는 로드 밸런서
-   4계층에서 동작하는 L4 스위치와 달리 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작하므로 다양한 부하 분산, 정보 수정, 필터링이 가능
-   ADC는 이런 상세한 동작을 위해 프락시로 동작
-   대부분의 ADC는 L4 스위치의 기능을 포함하고 있음
-   4계층에서 애플리케이션 계층까지 로드 밸런싱 기능을 제공하고 페일오버(Failover), 리다이렉션(Redirection) 기능도 함께 수행
-   이 외에도 애플리케이션 프로토콜을 이해하고 최적화하는 다양한 기능을 제공
-   캐싱(Caching), 압축(Compression), 콘텐츠 변환 및 재작성, 인코딩 변환 등이 가능하고 애플리케이션 프로토콜 최적화 기능도 제공
-   플러그인 형태로 보안 강화 기능을 추가로 제공해 WAF(Web Application Firewall) 기능이나 HTML, XML 검증과 변환을 수행

### 6.2.3 L4 스위치 vs ADC

-   L4 스위치는 4계층에서 동작하면서 TCP, UDP 정보를 기반으로 부하를 분산
-   부하 분산 뿐만 아니라 TCP 계층에서의 최적화와 보안 기능도 함께 제공
-   TCP 레벨의 간단한 DoS(Denial of Service) 공격을 방어하거나 서버 부하를 줄이기 위해 TCP 세션 재사용과 같이 보안과 성능을 높여주는 기능도 함께 제공
-   ADC는 애플리케이션 프로토콜을 이해하고 애플리케이션 내용에 대한 분산, 리다이렉션, 최적화를 제공해 L4 스위치보다 더 다향한 기능을 사용
-   ADC는 성능 최적화를 위해 서버에서 수행하는 작업 중 부하가 많이 걸리는 작업을 별도로 수행
-   그 중 하나가 이미지나 정적 콘텐츠 캐싱 기능
-   웹 서버에는 컨텐츠 압축 기능이 있지만 ADC에서 이 역할을 수행해 웹 서버의 부하를 줄일 수 있음
-   ADC는 하드웨어 가속이나 소프트웨어 최적화를 통해 이런 부하가 걸리는 작업을 최적화 하는 기능이 있음
-   ADC에서는 SSL의 엔드 포인트로 동작해 클라이언트에서 ADC까지의 구간을 SSL로 처리해주고 ADC와 웹 서버 사이를 일반 HTTP를 이용해 통신
